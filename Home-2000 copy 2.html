<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migra√ß√£o Firebase - Chat System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            margin: 20px 0;
        }
        .progress {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Migra√ß√£o do Sistema de Chat</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Esta migra√ß√£o ir√° reorganizar completamente a estrutura dos seus chats no Firebase.
            <br><br>
            <strong>O que acontecer√°:</strong>
            <ul>
                <li>Todos os chats ser√£o movidos para uma estrutura centralizada</li>
                <li>As mensagens ser√£o preservadas</li>
                <li>A estrutura antiga N√ÉO ser√° deletada automaticamente</li>
                <li>Execute este script apenas UMA vez</li>
            </ul>
        </div>

        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Preparando migra√ß√£o...</p>
        </div>

        <div class="log" id="logArea" style="display: none;"></div>

        <div style="text-align: center;">
            <button id="startMigration">üöÄ Iniciar Migra√ß√£o</button>
            <button id="testMigration">üß™ Testar Migra√ß√£o (Dry Run)</button>
            <button id="clearLog" style="background: #6c757d;">üóëÔ∏è Limpar Log</button>
        </div>

        <div id="resultArea"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            serverTimestamp,
            doc,
            getDoc,
            setDoc,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Config Firebase (mesma configura√ß√£o do seu projeto)
        const firebaseConfig = {
            apiKey: "AIzaSyB2N41DiH0-Wjdos19dizlWSKOlkpPuOWs",
            authDomain: "ifriendmatch.firebaseapp.com",
            projectId: "ifriendmatch",
            storageBucket: "ifriendmatch.appspot.com",
            messagingSenderId: "306331636603",
            appId: "1:306331636603:web:c0ae0bd22501803995e3de",
            measurementId: "G-D96BEW6RC3",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Elementos DOM
        const startBtn = document.getElementById('startMigration');
        const testBtn = document.getElementById('testMigration');
        const clearBtn = document.getElementById('clearLog');
        const logArea = document.getElementById('logArea');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultArea = document.getElementById('resultArea');

        // Fun√ß√£o para gerar ID √∫nico e consistente do chat
        function gerarChatId(user1, user2) {
            return `chat-${[user1, user2].sort().join("-")}`;
        }

        // Fun√ß√£o para adicionar log
        function addLog(message, type = 'info') {
            logArea.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        // Fun√ß√£o para atualizar progresso
        function updateProgress(current, total, text) {
            const percent = total > 0 ? (current / total) * 100 : 0;
            progressFill.style.width = `${percent}%`;
            progressText.textContent = `${text} (${current}/${total})`;
        }

        // Script de migra√ß√£o principal
        async function migrarChats(dryRun = false) {
            startBtn.disabled = true;
            testBtn.disabled = true;
            progressContainer.style.display = 'block';
            resultArea.innerHTML = '';

            addLog(`üîÑ Iniciando ${dryRun ? 'TESTE DE' : ''} migra√ß√£o...`);
            
            try {
                // Buscar todos os usu√°rios
                addLog("üìã Buscando todos os usu√°rios...");
                const usersSnap = await getDocs(collection(db, "users"));
                const totalUsers = usersSnap.size;
                addLog(`üë• Encontrados ${totalUsers} usu√°rios`);

                let processedUsers = 0;
                let totalChats = 0;
                let migratedChats = 0;
                const chatsMigrados = new Set();

                // Para cada usu√°rio
                for (const userDoc of usersSnap.docs) {
                    const username = userDoc.id;
                    updateProgress(processedUsers, totalUsers, `Processando usu√°rio: ${username}`);
                    
                    addLog(`üë§ Processando usu√°rio: ${username}`);

                    try {
                        // Buscar conversas do usu√°rio
                        const conversasSnap = await getDocs(collection(db, "users", username, "conversas"));
                        
                        for (const conversaDoc of conversasSnap.docs) {
                            const chatId = conversaDoc.id;
                            
                            try {
                                // Buscar usernames da conversa
                                const usernamesDoc = await getDoc(
                                    doc(db, "users", username, "conversas", chatId, "users", "usernames")
                                );

                                if (usernamesDoc.exists()) {
                                    const { username1, username2 } = usernamesDoc.data();
                                    const novoChatId = gerarChatId(username1, username2);
                                    
                                    // Evitar processar o mesmo chat m√∫ltiplas vezes
                                    if (chatsMigrados.has(novoChatId)) {
                                        continue;
                                    }

                                    totalChats++;
                                    addLog(`üí¨ Processando chat: ${chatId} -> ${novoChatId}`);

                                    if (!dryRun) {
                                        // Criar/verificar se o novo chat j√° existe
                                        const novoChatRef = doc(db, "chats", novoChatId);
                                        const novoChatDoc = await getDoc(novoChatRef);

                                        if (!novoChatDoc.exists()) {
                                            await setDoc(novoChatRef, {
                                                participants: [username1, username2].sort(),
                                                createdAt: serverTimestamp(),
                                                lastMessage: null,
                                                lastMessageTime: null,
                                            });
                                            addLog(`‚úÖ Chat criado: ${novoChatId}`);
                                        }

                                        // Migrar mensagens de ambos os tipos
                                        const tiposMensagem = [`mensagem-${username1}`, `mensagem-${username2}`];
                                        
                                        for (const tipoMensagem of tiposMensagem) {
                                            try {
                                                const mensagensSnap = await getDocs(
                                                    collection(db, "users", username, "conversas", chatId, tipoMensagem)
                                                );

                                                for (const msgDoc of mensagensSnap.docs) {
                                                    const msgData = msgDoc.data();
                                                    
                                                    // Adicionar √† nova estrutura
                                                    await addDoc(collection(db, "chats", novoChatId, "messages"), {
                                                        content: msgData.conteudo,
                                                        sender: msgData.username,
                                                        timestamp: msgData.enviadoEm || serverTimestamp(),
                                                        msgId: msgData.msgId || msgDoc.id,
                                                    });
                                                }
                                                
                                                if (mensagensSnap.size > 0) {
                                                    addLog(`üì® Migradas ${mensagensSnap.size} mensagens de ${tipoMensagem}`);
                                                }
                                            } catch (error) {
                                                addLog(`‚ùå Erro ao migrar mensagens ${tipoMensagem}: ${error.message}`, 'error');
                                            }
                                        }
                                    }

                                    chatsMigrados.add(novoChatId);
                                    migratedChats++;
                                }
                            } catch (error) {
                                addLog(`‚ùå Erro ao processar conversa ${chatId}: ${error.message}`, 'error');
                            }
                        }
                    } catch (error) {
                        addLog(`‚ùå Erro ao acessar conversas de ${username}: ${error.message}`, 'error');
                    }

                    processedUsers++;
                }

                updateProgress(totalUsers, totalUsers, "Migra√ß√£o conclu√≠da!");

                const resultHtml = `
                    <div class="success">
                        <h3>üéâ ${dryRun ? 'Teste de migra√ß√£o' : 'Migra√ß√£o'} conclu√≠da!</h3>
                        <p><strong>Usu√°rios processados:</strong> ${processedUsers}</p>
                        <p><strong>Chats ${dryRun ? 'encontrados' : 'migrados'}:</strong> ${migratedChats}</p>
                        ${!dryRun ? '<p><strong>‚ö†Ô∏è Lembre-se:</strong> As estruturas antigas ainda existem. Voc√™ pode remov√™-las manualmente ap√≥s verificar que tudo est√° funcionando.</p>' : ''}
                    </div>
                `;
                resultArea.innerHTML = resultHtml;

                addLog(`‚úÖ ${dryRun ? 'Teste' : 'Migra√ß√£o'} finalizada com sucesso!`, 'success');

            } catch (error) {
                const errorHtml = `
                    <div class="error">
                        <h3>‚ùå Erro durante a migra√ß√£o</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                resultArea.innerHTML = errorHtml;
                addLog(`‚ùå Erro geral: ${error.message}`, 'error');
            }

            startBtn.disabled = false;
            testBtn.disabled = false;
        }

        // Event listeners
        startBtn.addEventListener('click', () => migrarChats(false));
        testBtn.addEventListener('click', () => migrarChats(true));
        clearBtn.addEventListener('click', () => {
            logArea.innerHTML = '';
            logArea.style.display = 'none';
            resultArea.innerHTML = '';
            progressContainer.style.display = 'none';
        });

        addLog("‚úÖ Sistema de migra√ß√£o carregado. Pronto para uso!");
    </script>
</body>
</html>